{% extends 'accounting/accounting_base.html' %}
{% load static crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="app-content main-content">
    <div class="container-fluid">
        <div class="row mt-5">
            <div class="col-lg-12">
                <div class="card custom-card">
                    <div class="card-header border-bottom">
                        <h5 class="card-title mb-0">{{ title }}</h5>
                    </div>

                    <div class="card-body">
                        <form method="post" id="group-master-form" autocomplete="off">
                            {% csrf_token %}
                            
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- PRIMARY GROUP -->
                            <div class="card shadow-none border mb-4">
                                <div class="card-header bg-light"><h6 class="mb-0 text-primary">Primary Group Information</h6></div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">{{ form.branch|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.code|as_crispy_field }}</div>
                                        <div class="col-md-6">{{ form.name|as_crispy_field }}</div>
                                        <div class="col-md-6">{{ form.parent|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.nature_of_group|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.main_group|as_crispy_field }}</div>
                                        <div class="col-md-12">{{ form.description|as_crispy_field }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- SUB GROUPS -->
                            <div class="card shadow-none border mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-primary">Define Sub-Groups (Optional)</h6>
                                    <button type="button" id="add-subgroup" class="btn btn-sm btn-primary">+ Add Sub-Group</button>
                                </div>
                                <div class="card-body">
                                    {{ formset.management_form }}
                                    <div id="subgroup-container">
                                        {% for subgroup_form in formset.forms %}
                                        <div class="subgroup-row card mb-3 border shadow-none">
                                            <div class="card-body p-3">
                                                {% for hidden in subgroup_form.hidden_fields %}{{ hidden }}{% endfor %}
                                                <div class="float-end">
                                                    {% if subgroup_form.instance.pk %}
                                                        <div class="form-check">{{ subgroup_form.DELETE }} <label class="text-danger small">Delete</label></div>
                                                    {% else %}
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-new-row"><i class="fa fa-times"></i></button>
                                                    {% endif %}
                                                </div>
                                                <div class="row me-5">
                                                    <div class="col-md-2">{{ subgroup_form.code|as_crispy_field }}</div>
                                                    <div class="col-md-4">{{ subgroup_form.name|as_crispy_field }}</div>
                                                    <div class="col-md-3">{{ subgroup_form.nature_of_group|as_crispy_field }}</div>
                                                    <div class="col-md-3">{{ subgroup_form.main_group|as_crispy_field }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="card-footer bg-light d-flex justify-content-between">
                                <a href="{% url 'accounting:groupmaster_list' %}" class="btn btn-light border">Back</a>
                                <button type="submit" class="btn btn-success px-5">Save Group Master</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- INLINED EMPTY TEMPLATE (No separate file) -->
<div id="empty-subgroup-template" style="display:none;">
    <div class="subgroup-row card mb-3 border shadow-none bg-light">
        <div class="card-body p-3">
            {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
            <div class="float-end">
                <button type="button" class="btn btn-sm btn-outline-danger remove-new-row"><i class="fa fa-times"></i></button>
            </div>
            <div class="row me-5">
                <div class="col-md-2">{{ formset.empty_form.code|as_crispy_field }}</div>
                <div class="col-md-4">{{ formset.empty_form.name|as_crispy_field }}</div>
                <div class="col-md-3">{{ formset.empty_form.nature_of_group|as_crispy_field }}</div>
                <div class="col-md-3">{{ formset.empty_form.main_group|as_crispy_field }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
$(function () {
    // 1. AJAX: Update Code when Branch changes
    $('#id_branch').on('change', function () {
        const branchId = $(this).val();
        if (branchId) {
            $.ajax({
                url: "{% url 'accounting:get_next_group_code_ajax' %}",
                data: { 'branch_id': branchId },
                success: function (data) {
                    $('#id_code').val(data.code);
                }
            });
        }
    });

    // 2. Add Subgroup
    $('#add-subgroup').on('click', function () {
        const totalForms = $('#id_subgroups-TOTAL_FORMS');
        const index = parseInt(totalForms.val());
        let html = $('#empty-subgroup-template').html().replace(/__prefix__/g, index);
        
        $('#subgroup-container').append(html);
        totalForms.val(index + 1);

        // Auto-fill Nature/Main Group from primary group
        const newRow = $('#subgroup-container').children().last();
        newRow.find('select[name$="-nature_of_group"]').val($('#id_nature_of_group').val());
        newRow.find('select[name$="-main_group"]').val($('#id_main_group').val());
    });

    // 3. Remove Row
    $(document).on('click', '.remove-new-row', function () {
        $(this).closest('.subgroup-row').remove();
        const totalForms = $('#id_subgroups-TOTAL_FORMS');
        totalForms.val(parseInt(totalForms.val()) - 1);
        
        // Re-index rows
        $('#subgroup-container .subgroup-row').each(function(index) {
            $(this).find(':input').each(function() {
                if(this.name) this.name = this.name.replace(/subgroups-\d+-/, 'subgroups-' + index + '-');
                if(this.id) this.id = this.id.replace(/subgroups-\d+-/, 'subgroups-' + index + '-');
            });
        });
    });
});
</script>
{% endblock %}