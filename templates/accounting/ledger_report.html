{% extends 'accounting/accounting_base.html' %}
{% load static humanize %}

{% block content %}

{% block javascript %}
<script>
$(document).ready(function() {
    // Initialize flatpickr for date inputs
    $('input[name="start_date"]').flatpickr({
        dateFormat: 'Y-m-d',
        allowInput: true,
        clickOpens: true
    });
    
    $('input[name="end_date"]').flatpickr({
        dateFormat: 'Y-m-d',
        allowInput: true,
        clickOpens: true
    });
    
    // Initialize select2 for account selection
    $('select[name="account"]').select2({
        placeholder: '-- Choose Account --',
        allowClear: true,
        width: '100%',
        dropdownParent: $(document.body) // Ensures dropdown renders properly
    });
});
</script>
{% endblock %}


<div class="app-content main-content">

<div class="container-fluid">


<div class="accounting-header">
    <h2><i class="fas fa-book me-2"></i>{{ title|default:"Ledger Report" }}</h2>
    <p>View detailed ledger transactions for accounts</p>
</div>

<div class="custom-card card accounting-card">
    <div class="card-body">
        <!-- Filter Form -->
        <form method="get" class="mb-4 bg-light p-3 rounded border">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Select Account</label>
                    <select name="account" class="form-select select2" required>
                        <option value="">-- Choose Account --</option>
                        {% for account in object_list %}
                            <option value="{{ account.id }}" 
                                {% if selected_account_id == account.id %}selected{% endif %}>
                                {{ account.name }} ({{ account.code }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">From Date</label>
                    <input type="text" name="start_date" class="form-control flatpickr-input" 
                           value="{{ start_date|date:'Y-m-d' }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">To Date</label>
                    <input type="text" name="end_date" class="form-control flatpickr-input" 
                           value="{{ end_date|date:'Y-m-d' }}" readonly>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i> Search
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Results Section -->
        {% if selected_account %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-0 text-primary">{{ selected_account.name }}</h4>
                    <span class="text-muted small">Code: {{ selected_account.code }} | Group: {{ selected_account.under }}</span>
                </div>
                <div class="text-end border p-2 rounded bg-light">
                    <span class="d-block text-muted small">Closing Balance</span>
                    <strong class="fs-5 {% if closing_balance < 0 %}text-danger{% else %}text-success{% endif %}">
                        â‚¹{{ closing_balance|floatformat:2 }}
                    </strong>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Voucher</th>
                            <th>Description</th>
                            <th class="text-end">Debit</th>
                            <th class="text-end">Credit</th>
                            <th class="text-end">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Opening Balance Row -->
                        <tr class="table-warning fw-bold">
                            <td colspan="3">Opening Balance (b/f)</td>
                            <td class="text-end text-muted">-</td>
                            <td class="text-end text-muted">-</td>
                            <td class="text-end">{{ opening_balance|floatformat:2 }}</td>
                        </tr>

                        <!-- Transaction Rows -->
                        {% for entry in entries %}
                        <tr>
                            <td>{{ entry.transaction.date|date:"d M Y" }}</td>
                            <td>{{ entry.transaction.voucher_number }}</td>
                            <td>{{ entry.description|default:"-" }}</td>
                            <td class="text-end">
                                {% if entry.debit_amount > 0 %}
                                    {{ entry.debit_amount|floatformat:2 }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if entry.credit_amount > 0 %}
                                    {{ entry.credit_amount|floatformat:2 }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">{{ entry.running_balance|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                No transactions found in this date range.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-5 text-muted border rounded bg-light mt-3">
                <i class="fas fa-list-alt fa-3x mb-3"></i>
                <h5>No Account Selected</h5>
                <p>Please select an account and click "Search" to view the ledger.</p>
            </div>
        {% endif %}
    </div>
</div>

</div>
</div>
{% endblock %}