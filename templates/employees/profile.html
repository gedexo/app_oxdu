{% extends 'app/base.html' %}
{% load static i18n crispy_forms_tags %}
{% block title %}{{object}}: {{app_settings.site_title}}{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: white !important;
        color: black;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 20px;
        position: relative;
        border: 1px solid #ee4c2457;
    }
    .profile-image-container {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        margin: 0 auto 15px;
    }
    .profile-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .profile-name {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 5px;
    }
    .profile-title {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    .info-card {
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        border: 1px solid #ee4c2457;
    }
    .info-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eaecef;
        font-weight: 600;
        padding: 15px 20px;
        border-radius: 10px 10px 0 0 !important;
    }
    .info-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
    }
    .info-item:last-child {
        border-bottom: none;
    }
    .info-label {
        min-width: 180px;
        font-weight: 500;
        color: #6c757d;
    }
    .info-value {
        flex: 1;
        color: #343a40;
    }
    .edit-icon {
        color: #6c757d;
        cursor: pointer;
        margin-left: 10px;
        font-size: 16px;
    }
    .edit-icon:hover {
        color: #0d6efd;
    }
    .document-badge {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 5px 10px;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
    }
    .document-badge a {
        color: #495057;
        text-decoration: none;
    }
    .document-badge a:hover {
        color: #0d6efd;
    }
    .modal-content {
        border-radius: 10px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    .btn-primary {
        background: linear-gradient(90deg, #ee4c24, #eb135e) !important;
        border: none;
        border-radius: 6px;
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #d1431f, #d11154) !important;
    }
    .photo-upload-container {
        position: relative;
        display: inline-block;
    }
    .photo-upload-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .photo-upload-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.05);
    }
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f1f1f1;
    }
    .uneditable-field {
        color: #6c757d;
        font-style: italic;
    }

    @media(max-width:991px){
        .info-value{
            width: 30% !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content app-content">
    <div class="container-fluid">
        <!-- Page Header -->
        {% comment %} <div class="page-header d-flex d-block justify-content-between">
            <div class="page-leftheader">
                <div class="page-title">{{ title|title }}</div>
            </div>
            <div class="page-rightheader">
                <div class="btn-list">
                    <a class="btn btn-light3" href="javascript:void(0);" onclick="window.print();" data-bs-placement="top"
                        data-bs-toggle="tooltip" title="Print"> <i class="fe fe-printer"></i> </a>
                </div>
            </div>
        </div> {% endcomment %}
        <!-- Page Header Close -->

        <!-- Start::row-1 -->
        <div class="row mt-5">
            <div class="col-md-12">
                {% if employee %}  <!-- Changed from object to employee -->
                <div class="profile-header text-center">
                    <div class="photo-upload-container">
                        <div class="profile-image-container">
                            <img id="profile-image" src="{{ employee.get_image_url }}" class="profile-image" alt="{{ employee.fullname }}">  <!-- Changed object to employee -->
                        </div>
                        <div class="photo-upload-btn" data-bs-toggle="modal" data-bs-target="#photoUploadModal">
                            <i class="fe fe-camera"></i>
                        </div>
                    </div>
                    <h2 class="profile-name">{{ employee.fullname }}</h2>  <!-- Changed object to employee -->
                    <p class="profile-title">{{ employee.designation }} | {{ employee.department }}</p>  <!-- Changed object to employee -->
                </div>

                <div class="row">
                    <!-- Personal Information -->
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Personal Information</span>
                                <i class="fe fe-edit edit-icon" onclick="editSection('personal')"></i>
                            </div>
                            <div class="card-body p-0">
                                <div class="info-item">
                                    <div class="info-label">Employee ID</div>
                                    <div class="info-value">{{ employee.employee_id|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Full Name</div>
                                    <div class="info-value">{{ employee.fullname }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Gender</div>
                                    <div class="info-value">{{ employee.gender|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Date of Birth</div>
                                    <div class="info-value">{{ employee.date_of_birth|date:"d M Y"|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Mobile</div>
                                    <div class="info-value">{{ employee.mobile|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">WhatsApp</div>
                                    <div class="info-value">{{ employee.whatsapp|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Personal Email</div>
                                    <div class="info-value">{{ employee.personal_email|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Religion</div>
                                    <div class="info-value">{{ employee.religion|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Marital Status</div>
                                    <div class="info-value">{{ employee.marital_status|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Blood Group</div>
                                    <div class="info-value">{{ employee.blood_group|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                {% if employee.experience %}  <!-- Changed object to employee -->
                                <div class="info-item">
                                    <div class="info-label">Experience</div>
                                    <div class="info-value">{{ employee.experience|linebreaks }}</div>  <!-- Changed object to employee -->
                                </div>
                                {% endif %}
                                {% if employee.qualifications %}  <!-- Changed object to employee -->
                                <div class="info-item">
                                    <div class="info-label">Qualifications</div>
                                    <div class="info-value">{{ employee.qualifications|linebreaks }}</div>  <!-- Changed object to employee -->
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Emergency Contact -->
                        <div class="card info-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Emergency Contact</span>
                                <i class="fe fe-edit edit-icon" onclick="editSection('parent')"></i>
                            </div>
                            <div class="card-body p-0">
                                <div class="info-item">
                                    <div class="info-label">Father's Name</div>
                                    <div class="info-value">{{ employee.father_name|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Father's Mobile</div>
                                    <div class="info-value">{{ employee.father_mobile|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Mother's Name</div>
                                    <div class="info-value">{{ employee.mother_name|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Guardian Name</div>
                                    <div class="info-value">{{ employee.guardian_name|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Guardian Mobile</div>
                                    <div class="info-value">{{ employee.guardian_mobile|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Relationship</div>
                                    <div class="info-value">{{ employee.relationship_with_employee|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Company Information -->
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-header">
                                <span>Company Information</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="info-item">
                                    <div class="info-label">Official Email</div>
                                    <div class="info-value">{{ employee.official_email|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Department</div>
                                    <div class="info-value">{{ employee.department|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Designation</div>
                                    <div class="info-value">{{ employee.designation|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Course</div>
                                    <div class="info-value">{{ employee.course|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Date of Joining</div>
                                    <div class="info-value">{{ employee.date_of_joining|date:"d M Y"|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Date of Confirmation</div>
                                    <div class="info-value">{{ employee.date_of_confirmation|date:"d M Y"|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Employment Type</div>
                                    <div class="info-value">{{ employee.employment_type|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">
                                        <span class="badge bg-{% if employee.status == 'Active' %}success{% else %}warning{% endif %}">  <!-- Changed object to employee -->
                                            {{ employee.status }}  <!-- Changed object to employee -->
                                        </span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Is Also Telecaller</div>
                                    <div class="info-value">{{ employee.is_also_tele_caller|default:"No" }}</div>  <!-- Changed object to employee -->
                                </div>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <div class="card info-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Address Information</span>
                                <i class="fe fe-edit edit-icon" onclick="editSection('address')"></i>
                            </div>
                            <div class="card-body p-0">
                                <div class="info-item">
                                    <div class="info-label">Residence Type</div>
                                    <div class="info-value">{{ employee.type_of_residence|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Residence Name</div>
                                    <div class="info-value">{{ employee.residence_name|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Residential Address</div>
                                    <div class="info-value">{{ employee.residential_address|default:"-"|linebreaksbr }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Residence Contact</div>
                                    <div class="info-value">{{ employee.residence_contact|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Zip Code</div>
                                    <div class="info-value">{{ employee.residential_zip_code|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Permanent Address</div>
                                    <div class="info-value">{{ employee.permanent_address|default:"-"|linebreaksbr }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Permanent Zip Code</div>
                                    <div class="info-value">{{ employee.permanent_zip_code|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Details -->
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Bank Details</span>
                                <i class="fe fe-edit edit-icon" onclick="editSection('financial')"></i>
                            </div>
                            <div class="card-body p-0">
                                <div class="info-item">
                                    <div class="info-label">Bank Name</div>
                                    <div class="info-value">{{ employee.bank_name|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Account Name</div>
                                    <div class="info-value">{{ employee.account_name|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Account Number</div>
                                    <div class="info-value">{{ employee.account_number|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">IFSC Code</div>
                                    <div class="info-value">{{ employee.ifsc_code|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Bank Branch</div>
                                    <div class="info-value">{{ employee.bank_branch|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">PAN Number</div>
                                    <div class="info-value">{{ employee.pan_number|default:"-" }}</div>  <!-- Changed object to employee -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Salary Information -->
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-header">
                                <span>Salary Information</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="info-item">
                                    <div class="info-label">Basic Salary</div>
                                    <div class="info-value">₹{{ employee.basic_salary|default:"0" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">HRA</div>
                                    <div class="info-value">₹{{ employee.hra|default:"0" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Other Allowance</div>
                                    <div class="info-value">₹{{ employee.other_allowance|default:"0" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Transport Allowance</div>
                                    <div class="info-value">₹{{ employee.transportation_allowance|default:"0" }}</div>  <!-- Changed object to employee -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Total Salary</div>
                                    <div class="info-value">₹{{ employee.total_salary|default:"0" }}</div>  <!-- Changed object to employee -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documents -->
                    <div class="col-12">
                        <div class="card info-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Documents</span>
                                <i class="fe fe-edit edit-icon" onclick="editSection('documents')"></i>
                            </div>
                            <div class="card-body">
                                {% if employee.aadhar or employee.pancard or employee.offer_letter or employee.joining_letter or employee.agreement_letter or employee.experience_letter %}  <!-- Changed object to employee -->
                                <div class="d-flex flex-wrap">
                                    {% if employee.aadhar %}  <!-- Changed object to employee -->
                                    <div class="document-badge">
                                        <a href="{{ employee.aadhar.url }}" target="_blank"><i class="fe fe-file-text me-1"></i> Aadhar Card</a>  <!-- Changed object to employee -->
                                    </div>
                                    {% endif %}
                                    {% if employee.pancard %}  <!-- Changed object to employee -->
                                    <div class="document-badge">
                                        <a href="{{ employee.pancard.url }}" target="_blank"><i class="fe fe-file-text me-1"></i> PAN Card</a>  <!-- Changed object to employee -->
                                    </div>
                                    {% endif %}
                                    {% if employee.offer_letter %}  <!-- Changed object to employee -->
                                    <div class="document-badge">
                                        <a href="{{ employee.offer_letter.url }}" target="_blank"><i class="fe fe-file-text me-1"></i> Offer Letter</a>  <!-- Changed object to employee -->
                                    </div>
                                    {% endif %}
                                    {% if employee.joining_letter %}  <!-- Changed object to employee -->
                                    <div class="document-badge">
                                        <a href="{{ employee.joining_letter.url }}" target="_blank"><i class="fe fe-file-text me-1"></i> Joining Letter</a>  <!-- Changed object to employee -->
                                    </div>
                                    {% endif %}
                                    {% if employee.agreement_letter %}  <!-- Changed object to employee -->
                                    <div class="document-badge">
                                        <a href="{{ employee.agreement_letter.url }}" target="_blank"><i class="fe fe-file-text me-1"></i> Agreement Letter</a>  <!-- Changed object to employee -->
                                    </div>
                                    {% endif %}
                                    {% if employee.experience_letter %}  <!-- Changed object to employee -->
                                    <div class="document-badge">
                                        <a href="{{ employee.experience_letter.url }}" target="_blank"><i class="fe fe-file-text me-1"></i> Experience Letter</a>  <!-- Changed object to employee -->
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <p class="text-muted mb-0">No documents uploaded</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card custom-card">
                    <div class="card-body">
                        <p class="text-center">There is nothing here</p>
                        <p class="text-center">Employee: {{ employee }}</p>  <!-- Debug info -->
                        <p class="text-center">User: {{ request.user }}</p>  <!-- Debug info -->
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <!--End::row-1 -->
    </div>
</div>

<!-- Photo Upload Modal -->
<div class="modal fade" id="photoUploadModal" tabindex="-1" aria-labelledby="photoUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoUploadModalLabel">Update Profile Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="photoUploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="photo" class="form-label">Select a new photo</label>
                        <input class="form-control" type="file" id="photo" name="photo" accept="image/*">
                    </div>
                    <div class="text-center">
                        <img id="photoPreview" src="{% if employee %}{{ employee.get_image_url }}{% endif %}" class="profile-image-container img-fluid rounded" style="max-width: 200px;">  <!-- Changed object to employee -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload Photo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Section Modal -->
<div class="modal fade" id="editSectionModal" tabindex="-1" aria-labelledby="editSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSectionModalLabel">Edit Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editSectionForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body" id="editSectionFormBody">
                    <!-- Form fields will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
<!-- Include SweetAlert2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

<script>
    // Photo preview functionality
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photoPreview').src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Function to show SweetAlert notifications
    function showAlert(icon, title, text) {
        Swal.fire({
            icon: icon,
            title: title,
            text: text,
            timer: 3000,
            showConfirmButton: false
        });
    }

    // AJAX form submission for photo upload
    document.getElementById('photoUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                // Update profile image on success
                document.getElementById('profile-image').src = URL.createObjectURL(formData.get('photo'));
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('photoUploadModal')).hide();
                // Show success message
                showAlert('success', 'Success', 'Profile photo updated successfully!');
            } else {
                showAlert('error', 'Error', 'Error updating profile photo. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error', 'An error occurred. Please try again.');
        });
    });

    // Function to load edit form via AJAX
    function editSection(section) {
        // Show loading state
        document.getElementById('editSectionFormBody').innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading form...</p></div>';
        
        // Show the modal
        const editModal = new bootstrap.Modal(document.getElementById('editSectionModal'));
        editModal.show();
        
        // Update modal title based on section
        const sectionTitles = {
            'personal': 'Personal Information',
            'parent': 'Emergency Contact',
            'address': 'Address Information',
            'financial': 'Bank Details',
            'documents': 'Documents'
        };
        document.getElementById('editSectionModalLabel').textContent = `Edit ${sectionTitles[section]}`;
        
        // Load form via AJAX - Use the correct URL pattern
        fetch(`/employees/profile/edit/${section}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            document.getElementById('editSectionFormBody').innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('editSectionFormBody').innerHTML = '<div class="alert alert-danger">Error loading form. Please try again.</div>';
        });
    }

    // Handle edit form submission
    document.getElementById('editSectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const section = document.querySelector('input[name="section"]').value;
        
        // For document section, we need to ensure we're only submitting document fields
        if (section === 'documents') {
            // Remove non-document fields from formData to avoid validation errors
            const nonDocumentFields = ['employee_id', 'department', 'designation', 
                                    'is_also_tele_caller', 'status', 'branch'];
            nonDocumentFields.forEach(field => {
                if (formData.has(field)) {
                    formData.delete(field);
                }
            });
        }
        
        // Post to the correct URL for the specific section
        fetch(`/employees/profile/edit/${section}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('editSectionModal')).hide();
                // Show success message
                showAlert('success', 'Success', 'Information updated successfully!');
                // Reload the page to see changes
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                let errorMessage = 'Error updating information. Please check your inputs and try again.';
                if (data.errors) {
                    // Display specific form errors
                    errorMessage = Object.values(data.errors).flat().join('\n');
                }
                showAlert('error', 'Error', errorMessage);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error', 'An error occurred. Please try again.');
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}