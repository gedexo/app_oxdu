{% extends 'app/base.html' %}
{% load static i18n crispy_forms_tags %}
{% block title %}{{title}}: {{app_settings.site_title}}{% endblock %}

{% block content %}

<div class="main-content app-content">
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="page-header d-flex d-block justify-content-between">
            <div class="page-leftheader">
                <div class="page-title">{{ title|title }}</div>
            </div>
            <div class="page-rightheader">
                
            </div>
        </div>
        <!-- Page Header Close -->

        <!-- Start::row-1 -->
        <div class="row">
            <div class="col-md-12">
                <div class="card custom-card">
                    <div class="card-header d-flex justify-content-between border-bottom-0">
                        <div class="card-title">{{ sub_title|title }}</div>
                        <div class="btn-list">
                            {% if object %}
                                <a href="{{ object.get_delete_url }}" class="btn btn-light3" data-bs-placement="top"
                                data-bs-toggle="tooltip" title="Delete"> <i class="mdi mdi-delete"></i> </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <form method="post" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="row">

                                        {% if form.non_field_errors %}
                                            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                                        {% endif %}

                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                            {{ form.employee|as_crispy_field }}
                                        </div>

                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-2" id="div_id_payroll" style="display:none;">
                                            {{ form.payroll|as_crispy_field }}
                                            <div class="d-flex justify-content-between">
                                                <div id="payroll_amount_info" style="font-weight:semibold; font-size: 12px;"></div>
                                                <div id="payroll_remaining_info" style="font-weight:semibold; font-size: 12px;"></div>
                                                <div id="payroll_empty_message" style="font-weight:semibold; font-size: 12px; color:red; display:none;"></div>
                                            </div>
                                        </div>


                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                            {{ form.payment_date|as_crispy_field }}
                                        </div>

                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                            {{ form.amount_paid|as_crispy_field }}
                                            <div id="amount_paid_help" class="form-text"></div>
                                            <div id="amount_paid_error_message" style="font-weight:semibold; font-size: 12px; color:red; display:none;"></div>
                                            {% if form.amount_paid.errors %}
                                                <div class="text-danger">{{ form.amount_paid.errors|striptags }}</div>
                                            {% endif %}
                                        </div>

                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                            {{ form.payment_method|as_crispy_field }}
                                        </div>

                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                            {{ form.reference_number|as_crispy_field }}
                                        </div>

                                        <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 mb-3">
                                        {{ form.remarks|as_crispy_field }}
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-success">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                      
                        
                    </div>
                    
                </div>
            </div>
        </div>
        <!--End::row-1 -->

    </div>
</div>

{% endblock content %}


{% block javascript %}

{{form.media}}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const employeeSelect = document.getElementById("id_employee");
    const payrollSelect = document.getElementById("id_payroll");
    const payrollDiv = document.getElementById("div_id_payroll");
    const amountPaidInput = document.getElementById("id_amount_paid");
    const payrollAmountInfo = document.getElementById("payroll_amount_info");
    // reuse your existing element id; this was the cause of errors if the new id didn't exist
    const payrollRemainingInfo = document.getElementById("payroll_remaining_info");
    const amountPaidHelp = document.getElementById("amount_paid_help");
    const amountPaidError = document.getElementById("amount_paid_error_message");
    const payrollEmptyMessage = document.getElementById("payroll_empty_message");
    const ajaxUrl = "{% url 'employees:ajax_get_employee_payrolls' %}";

    const monthNames = [
        "", "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];

    // Safe select2 init (if present)
    if (window.$ && typeof window.$ === "function") {
        try {
            if (document.getElementById("id_employee")) $('#id_employee').select2({ placeholder: 'Select an employee', width: '100%' });
            if (document.getElementById("id_payroll")) $('#id_payroll').select2({ placeholder: 'Select a payroll', width: '100%' });
        } catch (e) {
            console.warn("select2 init error:", e);
        }
    }

    const safeText = (el, text) => { if (el) el.innerText = text; };

    function updatePayrollInfo() {
        try {
            if (!payrollSelect) return;

            const selected = payrollSelect.selectedOptions ? payrollSelect.selectedOptions[0] : payrollSelect.options[payrollSelect.selectedIndex];
            if (!selected || !selected.value) {
                safeText(payrollAmountInfo, "");
                safeText(payrollRemainingInfo, "");
                if (amountPaidInput) { amountPaidInput.value = ""; amountPaidInput.disabled = true; amountPaidInput.removeAttribute("max"); }
                if (amountPaidHelp) amountPaidHelp.innerText = "";
                if (amountPaidError) { amountPaidError.style.display = "none"; amountPaidError.innerText = ""; }
                return;
            }

            // Get basic salary from dataset; support different dataset key styles
            const ds = selected.dataset || {};
            const basicSalaryStr = ds.basicSalary ?? ds.basic_salary ?? ds.amount ?? "";
            const basicSalary = Number(basicSalaryStr);

            if (!isFinite(basicSalary)) {
                safeText(payrollAmountInfo, "Basic Salary: N/A");
                safeText(payrollRemainingInfo, "Advance Limit (75%): N/A");
                if (amountPaidInput) { amountPaidInput.disabled = true; amountPaidInput.removeAttribute("max"); }
                return;
            }

            const maxAdvance = +(basicSalary * 0.75).toFixed(2);

            safeText(payrollAmountInfo, `Basic Salary: ${basicSalary}`);
            safeText(payrollRemainingInfo, `Advance Limit (75%): ${maxAdvance}`);

            if (amountPaidInput) {
                amountPaidInput.disabled = false;
                amountPaidInput.setAttribute("max", maxAdvance);
                amountPaidInput.oninput = function () {
                    const entered = Number(this.value || 0);
                    if (entered > maxAdvance) {
                        if (amountPaidError) { amountPaidError.style.display = "block"; amountPaidError.innerText = `Amount cannot exceed 75% of basic salary (${maxAdvance})`; }
                    } else {
                        if (amountPaidError) { amountPaidError.style.display = "none"; amountPaidError.innerText = ""; }
                    }
                };
            }

            if (amountPaidHelp) amountPaidHelp.innerText = `Maximum advance allowed is ${maxAdvance}`;
        } catch (err) {
            console.error("updatePayrollInfo error:", err);
        }
    }

    function fetchPayrolls(employeeId) {
        try {
            // Reset UI
            if (payrollSelect) {
                payrollSelect.innerHTML = '<option value="">---------</option>';
                if (window.$ && $('#id_payroll').data('select2')) {
                    $('#id_payroll').empty().append('<option value="">---------</option>').trigger('change.select2');
                }
            }
            if (payrollDiv) payrollDiv.style.display = "none";
            safeText(payrollAmountInfo, "");
            safeText(payrollRemainingInfo, "");
            if (amountPaidInput) { amountPaidInput.value = ""; amountPaidInput.disabled = true; amountPaidInput.removeAttribute("max"); }
            if (amountPaidHelp) amountPaidHelp.innerText = "";
            if (amountPaidError) { amountPaidError.style.display = "none"; amountPaidError.innerText = ""; }
            if (payrollEmptyMessage) { payrollEmptyMessage.style.display = "none"; payrollEmptyMessage.innerText = ""; }

            if (!employeeId) return;

            fetch(`${ajaxUrl}?employee_id=${encodeURIComponent(employeeId)}`, { credentials: 'same-origin' })
                .then(res => {
                    if (!res.ok) throw new Error("Network response was not ok");
                    return res.json();
                })
                .then(data => {
                    const list = Array.isArray(data.payrolls) ? data.payrolls : [];
                    if (list.length > 0) {
                        if (payrollDiv) payrollDiv.style.display = "block";
                        list.forEach((p, i) => {
                            const monthName = monthNames[Number(p.payroll_month)] || p.payroll_month || "";
                            const optionText = `${p.payroll_year || ""} ${monthName} - ${p.employee_name || ""}`.trim();
                            const option = new Option(optionText, p.id, false, false);
                            // attach basic salary (fallbacks: basic_salary, basicSalary, net_salary)
                            option.dataset.basicSalary = (p.basic_salary ?? p.basicSalary ?? p.net_salary ?? 0);
                            if (i === 0) option.selected = true;
                            payrollSelect.appendChild(option);
                        });

                        if (window.$ && $('#id_payroll').data('select2')) $('#id_payroll').trigger('change.select2');
                        updatePayrollInfo();
                    } else {
                        if (payrollDiv) payrollDiv.style.display = "block";
                        if (payrollEmptyMessage) {
                            payrollEmptyMessage.style.display = "block";
                            payrollEmptyMessage.innerText = "No pending payrolls available for this employee.";
                        }
                        if (amountPaidInput) amountPaidInput.disabled = true;
                    }
                })
                .catch(err => {
                    console.error("Error fetching payrolls:", err);
                    if (payrollEmptyMessage) {
                        payrollEmptyMessage.style.display = "block";
                        payrollEmptyMessage.innerText = "Error loading payrolls.";
                    }
                });
        } catch (err) {
            console.error("fetchPayrolls error:", err);
        }
    }

    // Bind events (safe for select2 or plain select)
    if (employeeSelect) {
        if (window.$ && $('#id_employee').data('select2')) {
            $('#id_employee').on('change', function () { fetchPayrolls(this.value); });
        } else {
            employeeSelect.addEventListener('change', function () { fetchPayrolls(this.value); });
        }
    }

    if (payrollSelect) {
        if (window.$ && $('#id_payroll').data('select2')) {
            $('#id_payroll').on('change', updatePayrollInfo);
        } else {
            payrollSelect.addEventListener('change', updatePayrollInfo);
        }
    }

    // If an employee is pre-selected (edit form), fetch payrolls
    if (employeeSelect && employeeSelect.value) fetchPayrolls(employeeSelect.value);
});
</script>
{% endblock %}