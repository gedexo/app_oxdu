<!-- 1. PREMIUM ASSETS -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<!-- 2. MODERN AUDIO EFFECTS -->
<!-- Note: preload="auto" is important here -->
<audio id="snd-beep-short" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" preload="auto"></audio>
<audio id="snd-beep-final" src="https://assets.mixkit.co/active_storage/sfx/958/958-preview.mp3" preload="auto"></audio>
<audio id="snd-fanfare" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>

<!-- 3. PERMISSION CARD (Shown ONLY if permission is FALSE) -->
<div id="audio-permission-overlay" class="celeb-overlay" style="display: none; background: rgba(255,255,255,0.7);">
    <div class="clean-modern-card" style="border: 2px solid var(--primary-orange); transform: scale(1);">
        <div class="card-body">
            <div class="success-icon-wrap" style="background: #cbd5e1; color: #64748b;">
                <i class="bi bi-volume-up-fill"></i>
            </div>
            <span class="status-badge">SYSTEM SETTINGS</span>
            <h1 class="student-name-display" style="font-size: 2.2rem; margin-bottom: 20px;">Enable Audio Alerts</h1>
            <p style="color: #64748b; font-weight: 500; margin-bottom: 30px; line-height: 1.6;">
                To hear real-time registration sounds, please tap the button below.
            </p>
            <button id="enable-btn" onclick="unlockAudio()" class="course-pill" style="border: none; cursor: pointer; width: 100%; justify-content: center; padding: 18px; background: var(--primary-orange); color: white;">
                <i class="bi bi-play-circle-fill"></i>
                <span>ACTIVATE SOUNDS</span>
            </button>
        </div>
    </div>
</div>

<!-- 4. CELEBRATION OVERLAY -->
<div id="celebration-overlay" class="celeb-overlay">
    <div id="countdown-wrapper" class="countdown-container">
        <h1 id="countdown-num"></h1>
    </div>
    
    <div id="celebration-card" class="clean-modern-card">
        <div class="card-body">
            <div class="success-icon-wrap">
                <div class="icon-rotating-ring"></div>
                <div class="check-bg"></div>
                <i class="bi bi-check-lg icon-checkmark"></i>
            </div>
            <span class="status-badge">REGISTRATION SUCCESSFUL</span>
            <h1 id="pop-student" class="student-name-display">---</h1>
            <div class="info-grid">
                <div class="info-box"><label>TELECALLER</label><h3 id="pop-telecaller">---</h3></div>
                <div class="info-box"><label>BRANCH</label><h3 id="pop-branch">---</h3></div>
            </div>
            <div class="celebration-footer">
                <div class="course-pill">
                    <i class="bi bi-mortarboard-fill"></i>
                    <span id="pop-course">Professional Course</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root { --primary-orange: #ee4c24; --deep-slate: #0f172a; }

    .celeb-overlay {
        position: fixed; inset: 0; z-index: 1000000;
        display: none; align-items: center; justify-content: center;
        background: rgba(255, 255, 255, 0.3); 
        backdrop-filter: blur(30px) saturate(180%);
    }

    .clean-modern-card {
        position: relative; width: 90%; max-width: 500px;
        background: white;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 45px; padding: 45px;
        box-shadow: 0 40px 100px rgba(15, 23, 42, 0.1);
        text-align: center; font-family: 'Outfit', sans-serif;
    }

    .success-icon-wrap {
        width: 90px; height: 90px; background: var(--primary-orange);
        border-radius: 50%; margin: 0 auto 30px; display: flex;
        align-items: center; justify-content: center; color: white;
        font-size: 3rem; position: relative;
    }

    .status-badge { font-size: 0.75rem; font-weight: 800; color: #94a3b8; letter-spacing: 4px; display: block; margin-bottom: 12px; }
    .student-name-display { font-size: 3.2rem; font-weight: 800; color: var(--deep-slate); margin-bottom: 35px; letter-spacing: -1.5px; line-height: 1.1; }

    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: rgba(15, 23, 42, 0.03); border-radius: 28px; padding: 22px; margin-bottom: 30px; }
    .info-box label { font-size: 0.65rem; font-weight: 800; color: #94a3b8; display: block; margin-bottom: 6px; }
    .info-box h3 { font-size: 1.1rem; font-weight: 700; color: var(--deep-slate); margin: 0; }

    .course-pill { display: inline-flex; align-items: center; gap: 10px; background: white; padding: 12px 28px; border-radius: 100px; font-weight: 700; color: var(--primary-orange); box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-decoration: none; }

    .countdown-container h1 { font-size: 18rem; font-weight: 900; color: var(--primary-orange); opacity: 0; transform: scale(0.5); font-family: 'Outfit', sans-serif; margin:0; }
    .number-pop-active { animation: snap-pop 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes snap-pop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

    .animate-bounce-in { animation: bounce-in 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    @keyframes bounce-in { 0% { transform: scale(0.8) translateY(50px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
    
    .icon-rotating-ring { position: absolute; inset: -8px; border: 3px solid transparent; border-top-color: var(--primary-orange); border-right-color: var(--primary-orange); border-radius: 50%; animation: rotate-ring 3s linear infinite; }
    @keyframes rotate-ring { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>

<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
<script>
    let isAudioUnlocked = false;

    // --- 1. SMART PERMISSION CHECK ---
    function checkAudioOnLoad() {
        // If they already clicked in this session, don't show the card
        if (sessionStorage.getItem('dashboard_audio_active') === 'true') {
            isAudioUnlocked = true;
            return;
        }

        const testAudio = document.getElementById('snd-beep-short');
        
        // Try to play without interaction
        testAudio.play()
            .then(() => {
                // Success! Browser allows sound automatically
                isAudioUnlocked = true;
                sessionStorage.setItem('dashboard_audio_active', 'true');
                testAudio.pause();
                testAudio.currentTime = 0;
            })
            .catch(() => {
                // Blocked: Show the modern permission card
                document.getElementById('audio-permission-overlay').style.display = 'flex';
            });
    }

    window.addEventListener('load', checkAudioOnLoad);

    // --- 2. THE UNLOCKER (The core fix) ---
    function unlockAudio() {
        const sounds = ['snd-beep-short', 'snd-beep-final', 'snd-fanfare'];
        
        // Browsers require an actual play() command inside a click event
        // We play the first sound immediately as a "Success Beep"
        const feedbackSound = document.getElementById('snd-beep-short');
        feedbackSound.play().then(() => {
            console.log("Audio Engine Unlocked Successfully");
            
            // Loop through others and prime them
            sounds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.muted = false; // Ensure not muted
                    el.play().then(() => { el.pause(); el.currentTime = 0; });
                }
            });

            isAudioUnlocked = true;
            sessionStorage.setItem('dashboard_audio_active', 'true');
            document.getElementById('audio-permission-overlay').style.display = 'none';
        }).catch(err => {
            alert("Please click the 'ACTIVATE SOUNDS' button directly.");
        });
    }

    // --- 3. PUSHER & CELEBRATION ---
    const pusher = new Pusher('{{ pusher_key }}', { cluster: 'ap2' });
    const channel = pusher.subscribe('admission-channel');
    channel.bind('new-admission-event', (data) => startCelebration(data));

    let isAnimating = false;

    function startCelebration(data) {
        if (isAnimating) return;
        isAnimating = true;

        document.getElementById('pop-telecaller').innerText = data.telecaller;
        document.getElementById('pop-student').innerText = data.student_name;
        document.getElementById('pop-branch').innerText = data.branch;
        document.getElementById('pop-course').innerText = data.course || "Professional Course";

        const overlay = document.getElementById('celebration-overlay');
        const countdownNum = document.getElementById('countdown-num');
        const wrapper = document.getElementById('countdown-wrapper');
        const card = document.getElementById('celebration-card');

        overlay.style.display = 'flex';
        card.style.display = 'none';
        wrapper.style.display = 'block';

        let count = 5;
        const tick = () => {
            countdownNum.innerText = count;
            countdownNum.classList.remove('number-pop-active');
            void countdownNum.offsetWidth; // Trigger CSS reset
            countdownNum.classList.add('number-pop-active');
            
            // Play Beeps
            if (count > 1) playSound('snd-beep-short');
            else if (count === 1) playSound('snd-beep-final');
        };

        tick();
        const timer = setInterval(() => {
            count--;
            if (count > 0) tick();
            else {
                clearInterval(timer);
                revealSuccess();
            }
        }, 1000);
    }

    function revealSuccess() {
        document.getElementById('countdown-wrapper').style.display = 'none';
        const card = document.getElementById('celebration-card');
        card.style.display = 'block';
        card.classList.add('animate-bounce-in');
        
        playSound('snd-fanfare');
        triggerConfetti();

        setTimeout(() => {
            document.getElementById('celebration-overlay').style.display = 'none';
            isAnimating = false; 
        }, 10000);
    }

    function playSound(id) {
        const el = document.getElementById(id);
        if (el && isAudioUnlocked) {
            el.currentTime = 0;
            el.play().catch(e => console.warn("Audio playback failed", e));
        }
    }

    function triggerConfetti() {
        const defaults = { origin: { y: 0.7 }, zIndex: 2000000 };
        confetti({ ...defaults, particleCount: 70, spread: 60 });
        confetti({ ...defaults, particleCount: 40, spread: 100 });
    }
</script>