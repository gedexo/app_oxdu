{% extends 'reports/base_report.html' %}
{% load static i18n humanize %}

{% block report_title %}{{ report_title }} ({{ current_year }}){% endblock %}

{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    /* 1. Flatpickr Visibility Fixes */
    .flatpickr-calendar {
        z-index: 1060 !important;
    }
    .flatpickr-input[readonly] {
        background-color: #fff !important;
        opacity: 1 !important;
        cursor: pointer;
    }

    /* 2. Card & Hover Effects */
    .card-dashboard-stat {
        border-radius: 10px;
        transition: transform 0.2s;
    }
    .card-dashboard-stat:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* 3. Chart Cursor & Height */
    #incomeExpenseChart {
        min-height: 350px; 
        cursor: pointer; /* Changes mouse to hand icon on hover */
    }
    
    /* Optional: Changes cursor to crosshair when touching the actual graph lines/bars */
    .apexcharts-inner {
        cursor: crosshair;
    }
</style>
{% endblock %}

{% block report_content %}

<!-- FILTER SECTION -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card custom-card">
            <div class="card-header">
                <div class="card-title">Filter Options</div>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="branch" class="form-label">Branch</label>
                        <select name="branch" id="branch" class="form-select form-control">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                                <option value="{{ branch.id }}" {% if selected_branch == branch.id %}selected{% endif %}>
                                    {{ branch.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="text" name="start_date" id="start_date" class="form-control datepicker" value="{{ start_date }}" placeholder="Select Start Date">
                    </div>
                    <div class="col-md-3">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="text" name="end_date" id="end_date" class="form-control datepicker" value="{{ end_date }}" placeholder="Select End Date">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary me-2"><i class="fe fe-filter"></i> Filter</button>
                        <a href="{{ request.path }}" class="btn btn-light"><i class="fe fe-refresh-cw"></i> Reset</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SUMMARY CARDS -->
<div class="row">
    <div class="col-xl-4 col-md-6">
        <div class="card custom-card card-dashboard-stat border-top border-success border-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar avatar-lg bg-success-transparent text-success brround me-3"><i class="fe fe-arrow-up-circle fs-20"></i></div>
                    <div>
                        <p class="mb-1 fs-12 text-muted">Total Income ({{ current_year }})</p>
                        <h3 class="mb-0 fw-bold">₹{{ total_income|default:0|floatformat:2|intcomma }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-md-6">
        <div class="card custom-card card-dashboard-stat border-top border-danger border-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar avatar-lg bg-danger-transparent text-danger brround me-3"><i class="fe fe-arrow-down-circle fs-20"></i></div>
                    <div>
                        <p class="mb-1 fs-12 text-muted">Total Expense ({{ current_year }})</p>
                        <h3 class="mb-0 fw-bold">₹{{ total_expense|default:0|floatformat:2|intcomma }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-md-6">
        <div class="card custom-card card-dashboard-stat border-top border-info border-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar avatar-lg {% if net_profit >= 0 %}bg-info-transparent text-info{% else %}bg-warning-transparent text-warning{% endif %} brround me-3">
                        <i class="fe {% if net_profit >= 0 %}fe-trending-up{% else %}fe-trending-down{% endif %} fs-20"></i>
                    </div>
                    <div>
                        <p class="mb-1 fs-12 text-muted">Net Profit/Loss</p>
                        <h3 class="mb-0 fw-bold {% if net_profit < 0 %}text-danger{% else %}text-success{% endif %}">₹{{ net_profit|default:0|floatformat:2|intcomma }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CHART SECTION -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card custom-card">
            <div class="card-header"><div class="card-title">Financial Overview</div></div>
            <div class="card-body">
                <div id="incomeExpenseChart"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js_plugins %}
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. Flatpickr
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d-m-Y",
            altInputClass: "form-control bg-white",
            allowInput: true
        });

        // 2. Chart
        const labels = {{ chart_labels|safe|default:"[]" }};
        const incomeData = {{ income_series|safe|default:"[]" }};
        const expenseData = {{ expense_series|safe|default:"[]" }};
        const profitData = {{ profit_series|safe|default:"[]" }};

        const options = {
            series: [
                { name: 'Income', type: 'column', data: incomeData },
                { name: 'Expense', type: 'column', data: expenseData },
                { name: 'Net Profit', type: 'line', data: profitData }
            ],
            chart: {
                height: 350,
                type: 'line',
                stacked: false,
                toolbar: { show: false }, // Disable zoom tools
                zoom: { enabled: false }   // Disable zooming
            },
            stroke: { width: [0, 0, 4], curve: 'smooth' },
            plotOptions: { bar: { columnWidth: '60%', borderRadius: 4 } },
            colors: ['#198754', '#dc3545', '#0dcaf0'],
            labels: labels,
            yaxis: {
                labels: { formatter: (val) => "₹" + val.toLocaleString('en-IN') }
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: { formatter: (y) => "₹ " + (y ? y.toLocaleString('en-IN') : 0) }
            },
            legend: { 
                position: 'top', 
                horizontalAlign: 'center' // Centered legend
            }
        };

        new ApexCharts(document.querySelector("#incomeExpenseChart"), options).render();
    });
</script>
{% endblock %}