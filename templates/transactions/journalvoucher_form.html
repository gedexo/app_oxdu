{% extends 'accounting/accounting_base.html' %}
{% load static i18n crispy_forms_tags extras %}
{% block title %}{{title}}: OXDU APP{% endblock %}

{% block extra_css %}
<style>
    /* Clean Spreadsheet Look */
    .table-formset thead th {
        background-color: #f8f9fa;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #495057;
        border-top: none;
        padding: 12px 8px;
    }
    .table-formset tbody td {
        padding: 0 !important;
        border: 1px solid #e9ecef;
    }
    .table-formset input, .table-formset select {
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        padding: 10px 12px;
    }
    .table-formset input:focus {
        background-color: #fffdf0;
        z-index: 1;
    }
    .total-row {
        background-color: #f1f4f9;
        font-weight: bold;
    }
    .total-row td {
        padding: 10px !important;
        vertical-align: middle;
    }
    .delete-row-btn {
        color: #dc3545;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .delete-row-btn:hover {
        transform: scale(1.2);
    }
    .voucher-metadata {
        background-color: #fcfcfc;
        border-bottom: 1px solid #eee;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }
    .select2-container--default .select2-selection--single {
        border: none !important;
        border-radius: 0 !important;
        height: 40px !important;
        padding-top: 5px;
    }
    .select2-container {
        width: 100% !important;
    }
    /* Hide the delete checkbox but keep functionality */
    .formset_row td:last-child input[type="checkbox"] {
        display: none;
    }
    .add-row-link {
        display: inline-block;
        margin-top: 10px;
        font-weight: 500;
        color: #0d6efd;
        text-decoration: none;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="main-content app-content">
    <div class="container-fluid">
        <div class="row mt-4">
            <div class="col-12">
                <div class="card custom-card shadow-sm">
                    <!-- Header -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="card-title mb-0">
                            <span class="text-muted fw-light">Accounting /</span> {{ title|title }}
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <form id="voucher-form" method="post" autocomplete="off" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <!-- Top Metadata Section -->
                            <div class="voucher-metadata">
                                <div class="row g-3">
                                    <div class="col-xl-3">
                                        {{ form.voucher_number|as_crispy_field }}
                                    </div>
                                    <div class="col-xl-3">
                                        {{ form.date|as_crispy_field }}
                                    </div>
                                    <div class="col-xl-3">
                                        {{ form.branch|as_crispy_field }}
                                    </div>
                                    <div class="col-xl-3">
                                        {{ form.reference|as_crispy_field }}
                                    </div>
                                    <div class="col-xl-12">
                                        {{ form.narration|as_crispy_field }}
                                    </div>
                                </div>
                            </div>

                            <!-- Table Section -->
                            <div class="px-4 pb-4">
                                {{ formset.management_form }}
                                <div class="table-responsive">
                                    <table class="table table-formset align-middle" id="items-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 30%;">Account</th>
                                                <th style="width: 35%;">Description</th>
                                                <th style="width: 15%; text-align: right;">Debit</th>
                                                <th style="width: 15%; text-align: right;">Credit</th>
                                                <th style="width: 5%;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="formset-body">
                                            {% for form in formset.forms %}
                                            <tr class="formset_row">
                                                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                                <td>{{ form.account|add_class:"form-control account-input" }}</td>
                                                <td>{{ form.description|add_class:"form-control" }}</td>
                                                <td>{{ form.debit_amount|add_class:"form-control debit_amount-input text-end" }}</td>
                                                <td>{{ form.credit_amount|add_class:"form-control credit_amount-input text-end" }}</td>
                                                <td class="text-center">
                                                    {% if formset.can_delete %}
                                                        <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="2" class="text-end text-muted pe-4">Totals</td>
                                                <td>
                                                    <input type="text" id="total-debit-display" class="form-control text-end fw-bold" readonly value="0.00">
                                                </td>
                                                <td>
                                                    <input type="text" id="total-credit-display" class="form-control text-end fw-bold" readonly value="0.00">
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                
                                <!-- Difference Alert -->
                                <div id="balance-alert" class="alert alert-danger border-danger mt-3 d-none">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <div>
                                            <strong>Out of Balance!</strong> Difference: <span id="balance-diff">0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Actions -->
                            <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" onclick="history.back()" class="btn btn-outline-secondary px-4">
                                        Cancel
                                    </button>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" name="save_add_new" class="btn btn-outline-primary">
                                        Save & Add Another
                                    </button>
                                    <button type="submit" class="btn btn-primary px-5 shadow-sm">
                                        <i class="fe fe-save me-1"></i> Save Voucher
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
{{ form.media }}
<script src="{% static 'app/assets/js/formset/formset.js' %}"></script>

<script>
$(document).ready(function () {

    /* -----------------------------
     * Calculate Totals & Balance
     * ----------------------------- */
    function updateTotals() {
        let totalDebit = 0;
        let totalCredit = 0;

        $('.formset_row:visible').each(function() {
            // Check if the row is marked for deletion (if using the plugin's hidden DELETE input)
            let isDeleted = $(this).find('input[id$="-DELETE"]').is(':checked');
            
            if (!isDeleted) {
                let debit = parseFloat($(this).find('.debit_amount-input').val()) || 0;
                let credit = parseFloat($(this).find('.credit_amount-input').val()) || 0;
                totalDebit += debit;
                totalCredit += credit;
            }
        });

        $('#total-debit-display').val(totalDebit.toFixed(2));
        $('#total-credit-display').val(totalCredit.toFixed(2));

        let diff = Math.abs(totalDebit - totalCredit);
        
        if (diff > 0.001) {
            $('#balance-diff').text(diff.toFixed(2));
            $('#balance-alert').removeClass('d-none');
        } else {
            $('#balance-alert').addClass('d-none');
        }
    }

    // Trigger calculation on input
    $(document).on('input', '.debit_amount-input, .credit_amount-input', function() {
        updateTotals();
    });

    /* -----------------------------
     * Branch & Account Logic
     * ----------------------------- */
    function disableAccountSelect(row) {
        row.find('.account-input').prop('disabled', true);
    }

    function enableAccountSelect(row) {
        row.find('.account-input').prop('disabled', false);
    }

    function loadAccountsForRow(row, branchId, selectedId = null) {
        let $account = row.find('.account-input');
        if (!branchId) {
            disableAccountSelect(row);
            return;
        }

        $.ajax({
            url: "{% url 'transactions:load_party_accounts' %}",
            type: "GET",
            data: { branch: branchId },
            success: function (data) {
                $account.empty().append('<option value="">Select Account</option>');
                data.forEach(function (item) {
                    let isSelected = (selectedId && item.id == selectedId);
                    $account.append($('<option>', { value: item.id, text: item.name, selected: isSelected }));
                });
                enableAccountSelect(row);
                $account.trigger('change.select2');
            }
        });
    }

    /* -----------------------------
     * Initialize Formset
     * ----------------------------- */
    $('.formset_row').formset({
        addText: '<i class="mt-1"></i> Add Row',
        deleteText: '<i class="fas fa-times"></i>',
        prefix: '{{ formset.prefix }}',
        formCssClass: 'formset_row',
        added: function (row) {
            // Initialize Select2 for new row
            initializeSelect2ForFormRow(row, '.account-input', null, "Search Account");
            
            let branchId = $('#id_branch').val();
            if (branchId) {
                loadAccountsForRow(row, branchId);
            } else {
                disableAccountSelect(row);
            }
            updateTotals();
        },
        removed: function () {
            updateTotals();
        }
    });

    // Handle Branch Change
    $('#id_branch').on('change', function () {
        let branchId = $(this).val();
        $('.formset_row').each(function () {
            loadAccountsForRow($(this), branchId);
        });
    });

    // Initial load logic
    function initExistingRows() {
        let branchId = $('#id_branch').val();
        $('.formset_row').each(function () {
            let row = $(this);
            initializeSelect2ForFormRow(row, '.account-input', null, "Search Account");
            if (!branchId) disableAccountSelect(row);
        });
        updateTotals(); // Calculate totals on page load
    }

    initExistingRows();
});
</script>
{% endblock javascript %}